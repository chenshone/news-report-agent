# 专家委员会协作机制设计

> 借鉴 [Andrej Karpathy 的 LLM Council](https://github.com/karpathy/llm-council) 项目思想，
> 为异质专家（不同职责）设计的交叉评审与共识讨论机制。

## 统一等级制（A/B/C/D）

整个 Agent 系统使用统一的 A/B/C/D 四级评估体系，包括：
- 内容可信度评估
- 内容相关性评估
- 专家分析质量评估
- 交叉评审结果

| 等级 | 含义 | 描述 | 行动建议 |
|------|------|------|----------|
| **A** | 优秀 | 质量高，无明显问题 | 直接采用 |
| **B** | 良好 | 质量较好，有小问题 | 可以采用 |
| **C** | 及格 | 有明显问题 | 谨慎采用，需改进 |
| **D** | 不及格 | 存在严重问题 | 建议剔除/重做 |

---

## 核心差异：同质 vs 异质专家

| 特性 | LLM Council (AK) | 本项目 Expert Council |
|------|------------------|----------------------|
| 专家类型 | 同质（不同LLM回答同一问题） | 异质（不同职责分析不同方面） |
| 评审目标 | 评价答案质量，投票排名 | 从专业视角互相检验 |
| 主席角色 | 综合最佳答案 | 裁决分歧，整合分析 |
| 匿名机制 | 隐藏模型身份 | 不需要（职责本就不同） |

## 四阶段协作流程

```
┌─────────────────────────────────────────────────────────────────────┐
│                    异质专家协作流程                                   │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  阶段 1: 独立分析 (First Opinions)                                   │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────────┐            │
│  │summarizer│ │fact_check│ │researcher│ │impact_assess │            │
│  └────┬─────┘ └────┬─────┘ └────┬─────┘ └──────┬───────┘            │
│       │            │            │               │                    │
│       └────────────┴────────────┴───────────────┘                    │
│                              │                                       │
│                     各专家独立输出分析结果                             │
│                              │                                       │
│  ════════════════════════════▼═══════════════════════════════════   │
│                                                                     │
│  阶段 2: 交叉评审 (Cross Review)                                     │
│  ┌──────────────────────────────────────────────────────┐           │
│  │  每位专家从自己的专业视角评审其他专家的输出              │           │
│  │                                                      │           │
│  │  fact_checker → summarizer: 摘要事实是否准确?        │           │
│  │  researcher → summarizer: 是否遗漏重要背景?          │           │
│  │  researcher → fact_checker: 核查是否全面?            │           │
│  │  fact_checker → researcher: 背景信息是否准确?        │           │
│  │  fact_checker → impact_assessor: 预测依据可靠?       │           │
│  │  researcher → impact_assessor: 有历史先例支撑?       │           │
│  └──────────────────────────────────────────────────────┘           │
│                              │                                       │
│  ════════════════════════════▼═══════════════════════════════════   │
│                                                                     │
│  阶段 3: 共识讨论 (Consensus Discussion)                             │
│  ┌──────────────────────────────────────────────────────┐           │
│  │  针对阶段2发现的分歧点进行结构化讨论                   │           │
│  │  - 评审等级为 C 或 D 时触发讨论                       │           │
│  │  - 严重性为 high 的问题触发讨论                       │           │
│  │  - 最多 2 轮讨论尝试达成共识                          │           │
│  └──────────────────────────────────────────────────────┘           │
│                              │                                       │
│  ════════════════════════════▼═══════════════════════════════════   │
│                                                                     │
│  阶段 4: 主管裁决 (Chairman Synthesis)                               │
│  ┌──────────────────────────────────────────────────────┐           │
│  │  expert_supervisor 综合:                              │           │
│  │  - 各专家原始分析                                     │           │
│  │  - 交叉评审意见和等级                                 │           │
│  │  - 讨论达成的共识和保留的分歧                         │           │
│  │  → 输出最终整合报告                                   │           │
│  └──────────────────────────────────────────────────────┘           │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

## 交叉评审矩阵

定义了哪位专家应该评审哪位专家的哪些方面：

```python
CROSS_REVIEW_MATRIX = {
    "summarizer": [
        {"reviewer": "fact_checker", "focus": "摘要中的事实声明是否准确？"},
        {"reviewer": "researcher", "focus": "摘要是否遗漏了重要背景？"},
        {"reviewer": "impact_assessor", "focus": "摘要是否涵盖关键要素？"},
    ],
    "fact_checker": [
        {"reviewer": "researcher", "focus": "核查是否全面？历史数据准确？"},
        {"reviewer": "summarizer", "focus": "核查结果与摘要是否一致？"},
    ],
    "researcher": [
        {"reviewer": "fact_checker", "focus": "背景信息是否准确？来源可靠？"},
        {"reviewer": "impact_assessor", "focus": "背景是否支撑影响分析？"},
    ],
    "impact_assessor": [
        {"reviewer": "researcher", "focus": "预测是否有历史依据？逻辑合理？"},
        {"reviewer": "fact_checker", "focus": "预测前提是否已验证？"},
    ],
}
```

## 评审等级说明（A/B/C/D 四级制）

| 等级 | 含义 | 标准 |
|------|------|------|
| **A** | 优秀 | 质量高，无明显问题，可直接采用 |
| **B** | 良好 | 质量较好，有小问题但不影响整体 |
| **C** | 及格 | 有明显问题，需要改进后才能采用 |
| **D** | 不及格 | 存在严重问题，需要重新分析 |

> **触发讨论的条件**：评审等级为 C 或 D

## 交叉评审输出格式

```json
{
  "overall_grade": "B",
  "grades": {
    "accuracy": "A",
    "completeness": "B",
    "consistency": "B",
    "logic": "A"
  },
  "issues": [
    {
      "severity": "high",
      "description": "融资金额与原文不符",
      "location": "核心要点第2条"
    }
  ],
  "agreement_points": [
    "事件时间线准确",
    "关键人物识别正确"
  ],
  "suggestions": [
    "建议核实融资具体金额",
    "建议补充公司历史融资信息"
  ],
  "conflicts_with_my_analysis": [
    {
      "topic": "融资规模",
      "their_position": "1亿美元",
      "my_position": "5000万美元",
      "evidence": "根据 TechCrunch 报道..."
    }
  ]
}
```

## 主管裁决输出格式

```markdown
# 专家委员会综合裁决

## 一、可靠结论（专家共识）

| 结论 | 支持专家 | 评审等级 | 证据强度 |
|------|----------|----------|----------|
| [结论1] | summarizer, fact_checker | A | 强 |

## 二、争议裁决

### 争议 1: [争议主题]
- **分歧描述**: ...
- **交叉评审意见**: ...
- **主管裁决**: 采纳 fact_checker 观点
- **裁决理由**: 有多个独立来源验证

## 三、待验证事项
- [ ] 需要后续关注...

## 四、最终整合报告
[整合所有专家分析的最终报告]

## 五、审核元信息
- **分析质量等级**: A/B/C/D
- **专家共识度**: 高/中/低
- **等级分布**: A=2, B=3, C=1, D=0
```

## 使用方式

### 方式一：直接使用 DiscussionCoordinator

```python
from src.agent import DiscussionCoordinator

# 定义任务执行器（调用各专家）
async def task_executor(expert_name: str, prompt: str) -> str:
    # 实现调用逻辑
    ...

coordinator = DiscussionCoordinator(
    task_executor=task_executor,
    max_discussion_rounds=2,
    consensus_threshold=0.7,
)

# 执行完整流程
session = await coordinator.run_full_council(
    task="分析这篇新闻的多维度影响",
    context="[新闻原文...]",
    expert_outputs={
        "summarizer": "摘要内容...",
        "fact_checker": "核查结果...",
        "researcher": "背景研究...",
        "impact_assessor": "影响评估...",
    }
)

# 获取结果
print(session.final_synthesis)  # 主管最终裁决
print(session.cross_reviews)    # 交叉评审详情
print(session.discussions)      # 讨论记录
```

### 方式二：集成到 MasterAgent 工作流

在 MasterAgent 的系统提示中，可以指示它在专家分析完成后调用协调器：

```
## 深度分析工作流（LLM Council 增强版）

1. 调用各专家独立分析（阶段1）
2. 调用协调器执行交叉评审（阶段2）
3. 如有分歧，组织讨论（阶段3）
4. 调用 expert_supervisor 综合裁决（阶段4）
5. 基于裁决生成最终报告
```

## 设计原理

### 为什么需要交叉评审？

1. **发现盲点**：每位专家有自己的专业视角，可能忽略其他维度的问题
2. **交叉验证**：多重检验提高输出可靠性
3. **暴露矛盾**：不同专家的分析可能存在不一致，需要被发现和解决

### 为什么需要讨论环节？

1. **共识形成**：通过对话让专家理解彼此立场，找到共同点
2. **观点迭代**：专家可以在讨论中修正自己的观点
3. **透明决策**：讨论过程被记录，裁决有据可循

### 为什么需要主管裁决？

1. **最终把关**：有人需要对整体质量负责
2. **整合视角**：将分散的专家意见整合成连贯叙事
3. **处理分歧**：对无法通过讨论解决的分歧做出决断

## 与 LLM Council 的对比

| 方面 | LLM Council | Expert Council |
|------|-------------|----------------|
| **目标** | 提高单一问题的回答质量 | 提高多维度分析的整体质量 |
| **评审** | 匿名排名投票 | 专业视角交叉检验 |
| **讨论** | 无（一轮评审） | 有（针对分歧） |
| **共识** | 通过排名聚合 | 通过讨论达成 |
| **主席** | 综合最佳答案 | 裁决分歧+整合报告 |

## 参考资料

- [LLM Council GitHub](https://github.com/karpathy/llm-council)
- [Andrej Karpathy 的 LLM Council 项目深度解析](background/llm-council.md)
