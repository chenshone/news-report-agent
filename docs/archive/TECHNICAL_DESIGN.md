# 热点资讯聚合 Agentic AI - 技术架构设计

## 一、设计理念

### 1.1 Agentic AI 四大范式

本系统严格遵循 Agentic AI 的四大核心范式：

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        Agentic AI 四大范式                               │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────┐ │
│   │   规划      │    │   反思      │    │  工具使用   │    │  多智能  │ │
│   │  Planning   │    │ Reflection  │    │  Tool Use   │    │ 体协作   │ │
│   │             │    │             │    │             │    │  (MAC)   │ │
│   └──────┬──────┘    └──────┬──────┘    └──────┬──────┘    └────┬────┘ │
│          │                  │                  │                 │      │
│          ▼                  ▼                  ▼                 ▼      │
│   ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────┐ │
│   │ write_todos │    │ 自我评估    │    │ 搜索/抓取   │    │ 子Agent │ │
│   │ 任务分解    │    │ 策略调整    │    │ 筛选/分析   │    │ 专家协作 │ │
│   │ 动态规划    │    │ 质量检查    │    │ 文件系统    │    │ 任务委派 │ │
│   └─────────────┘    └─────────────┘    └─────────────┘    └─────────┘ │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

| 范式 | 描述 | 在本系统中的体现 |
|------|------|------------------|
| **规划 (Planning)** | Agent 能够将复杂任务分解为子任务，制定执行策略 | 使用 `write_todos` 生成任务清单，动态调整检索策略 |
| **反思 (Reflection)** | Agent 能够评估自身行为和结果，进行自我修正 | 检索后评估结果充分性，分析后检查一致性，必要时调整策略 |
| **工具使用 (Tool Use)** | Agent 能够调用外部工具扩展能力边界 | 调用搜索API、网页抓取、文件系统等工具完成具体操作 |
| **多智能体协作 (MAC)** | 多个 Agent 分工协作，各司其职 | 派生专家子Agent（摘要、核查、影响评估等）协作分析 |

### 1.2 核心设计原则

- **Agent 驱动**：以 DeepAgents 主 Agent 为核心，通过 Todo 列表自主规划和推进任务
- **文件系统即记忆**：利用 DeepAgents 虚拟文件系统存储中间结果，突破上下文窗口限制
- **专家分工**：通过子 Agent 实现多视角分析，每个专家有独立的上下文和工具
- **渐进式执行**：任务逐步推进，每步都可反思和调整

---

## 二、技术栈

### 2.1 核心框架

| 组件 | 技术选型 | 说明 |
|------|---------|------|
| Agent 框架 | **DeepAgents** | 提供规划、文件系统、子Agent派生等核心能力 |
| 底层编排 | LangGraph | DeepAgents 底层依赖，提供状态管理和可视化 |
| LLM 抽象 | LangChain | 模型适配和工具调用 |
| 搜索工具 | Tavily | 网络搜索 API |

### 2.2 DeepAgents 内置能力

DeepAgents 提供的开箱即用能力，本系统直接复用：

| 中间件 | 功能 | 用途 |
|--------|------|------|
| **TodoListMiddleware** | `write_todos` / `read_todos` | 任务规划与进度追踪 |
| **FilesystemMiddleware** | `ls` / `read_file` / `write_file` / `edit_file` / `glob` / `grep` | 上下文管理与结果存储 |
| **SubAgentMiddleware** | `task()` | 派生专家子Agent，隔离上下文 |
| **SummarizationMiddleware** | 自动摘要 | 上下文超长时自动压缩 |

---

## 三、系统架构

### 3.1 整体架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              用户层                                          │
│     ┌─────────┐        ┌─────────┐        ┌─────────┐                       │
│     │   CLI   │        │ Web API │        │  定时器  │                       │
│     └────┬────┘        └────┬────┘        └────┬────┘                       │
└──────────┼──────────────────┼──────────────────┼────────────────────────────┘
           │                  │                  │
           └──────────────────┴──────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                        MasterAgent (DeepAgents)                             │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                         内置中间件                                      │ │
│  │  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐ ┌──────────────┐  │ │
│  │  │ TodoList     │ │ Filesystem   │ │ SubAgent     │ │Summarization │  │ │
│  │  │ Middleware   │ │ Middleware   │ │ Middleware   │ │ Middleware   │  │ │
│  │  └──────────────┘ └──────────────┘ └──────────────┘ └──────────────┘  │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                         自定义工具                                      │ │
│  │  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐ ┌──────────────┐  │ │
│  │  │ internet_    │ │ fetch_page   │ │ evaluate_    │ │ ...          │  │ │
│  │  │ search       │ │              │ │ credibility  │ │              │  │ │
│  │  └──────────────┘ └──────────────┘ └──────────────┘ └──────────────┘  │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                         专家子Agent                                    │ │
│  │  ┌────────────┐ ┌────────────┐ ┌────────────┐ ┌────────────┐         │ │
│  │  │ 摘要专家   │ │ 核查专家   │ │ 研究专家   │ │ 影响评估   │         │ │
│  │  │ summarizer │ │fact_checker│ │ researcher │ │  assessor  │         │ │
│  │  └────────────┘ └────────────┘ └────────────┘ └────────────┘         │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                        虚拟文件系统 (Context Memory)                         │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐           │
│  │ /raw/       │ │ /filtered/  │ │ /analysis/  │ │ /reports/   │           │
│  │ 原始检索结果 │ │ 筛选后内容  │ │ 专家分析    │ │ 最终报告    │           │
│  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘           │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.2 Agent 执行流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           Agent 执行流程                                     │
│                                                                             │
│  用户: "分析今天科技圈的热点"                                                │
│         │                                                                   │
│         ▼                                                                   │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 1️⃣ 规划阶段 (Planning)                                              │   │
│  │    Agent 调用 write_todos 生成任务清单：                             │   │
│  │    ├─ [pending] 搜索"科技 热点 today"                               │   │
│  │    ├─ [pending] 搜索"AI 最新进展"                                   │   │
│  │    ├─ [pending] 筛选高质量内容                                      │   │
│  │    ├─ [pending] 派生专家进行多维度分析                              │   │
│  │    ├─ [pending] 整合分析结果                                        │   │
│  │    └─ [pending] 生成最终报告                                        │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│         │                                                                   │
│         ▼                                                                   │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 2️⃣ 检索阶段 (Tool Use)                                              │   │
│  │    Agent 逐个执行搜索 todo：                                         │   │
│  │    ├─ 调用 internet_search("科技 热点 today")                       │   │
│  │    ├─ 调用 internet_search("AI 最新进展")                           │   │
│  │    └─ 结果写入 /raw/articles.json                                   │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│         │                                                                   │
│         ▼                                                                   │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 3️⃣ 反思检查点 (Reflection)                                          │   │
│  │    Agent 评估检索结果：                                              │   │
│  │    ├─ 结果数量是否足够？                                            │   │
│  │    ├─ 覆盖面是否全面？                                              │   │
│  │    └─ 如不足 → 调整策略，添加新的搜索 todo                          │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│         │                                                                   │
│         ▼                                                                   │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 4️⃣ 筛选阶段 (Tool Use)                                              │   │
│  │    Agent 评估每条内容：                                              │   │
│  │    ├─ 调用 evaluate_credibility 评估可信度                          │   │
│  │    ├─ LLM 评估相关性                                                │   │
│  │    └─ 筛选结果写入 /filtered/articles.json                          │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│         │                                                                   │
│         ▼                                                                   │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 5️⃣ 多专家分析 (Multi-Agent Collaboration)                           │   │
│  │    Agent 使用 task() 派生子 Agent：                                  │   │
│  │    ┌─────────────────────────────────────────────────────────────┐  │   │
│  │    │  task("summarizer", "提取文章核心要点")     → /analysis/sum  │  │   │
│  │    │  task("fact_checker", "核查关键事实")      → /analysis/fact │  │   │
│  │    │  task("researcher", "补充背景信息")        → /analysis/bg   │  │   │
│  │    │  task("impact_assessor", "评估潜在影响")   → /analysis/imp  │  │   │
│  │    └─────────────────────────────────────────────────────────────┘  │   │
│  │    各子 Agent 独立工作，结果写入文件系统                             │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│         │                                                                   │
│         ▼                                                                   │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 6️⃣ 整合与一致性检查 (Reflection)                                    │   │
│  │    Agent 读取各专家分析结果：                                        │   │
│  │    ├─ 检查是否存在矛盾观点                                          │   │
│  │    ├─ 整合多维度分析                                                │   │
│  │    └─ 如有冲突 → 协调专家补充分析                                   │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│         │                                                                   │
│         ▼                                                                   │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 7️⃣ 报告生成 (Tool Use)                                              │   │
│  │    Agent 生成最终报告：                                              │   │
│  │    ├─ 读取整合后的分析                                              │   │
│  │    ├─ 生成概述和结论                                                │   │
│  │    ├─ 渲染 Markdown 模板                                            │   │
│  │    └─ 写入 /reports/final.md                                        │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│         │                                                                   │
│         ▼                                                                   │
│  返回报告给用户                                                            │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 四、核心组件设计

### 4.1 MasterAgent 配置

MasterAgent 是系统的核心，基于 DeepAgents 的 `create_deep_agent` 创建：

| 配置项 | 说明 |
|--------|------|
| **model** | 主 Agent 使用的 LLM（如 `gpt-4o` 或 `claude-sonnet`） |
| **system_prompt** | 定制的系统提示词，描述工作流程和约束 |
| **tools** | 自定义工具列表（搜索、抓取、评估等） |
| **subagents** | 专家子 Agent 定义列表 |
| **backend** | 文件系统后端配置（内存/磁盘） |

### 4.2 自定义工具

在 DeepAgents 内置工具基础上，添加领域特定工具：

| 工具 | 功能 | 输入 | 输出 |
|------|------|------|------|
| `internet_search` | 网络搜索 | query, max_results, topic | 搜索结果列表 |
| `fetch_page` | 抓取网页正文 | url, max_length | 正文文本 |
| `evaluate_credibility` | 评估来源可信度 | url, title | 可信度分数 + 原因 |
| `evaluate_relevance` | 评估内容相关性 | content, domain | 相关性分数 |

### 4.3 专家子Agent

通过 DeepAgents 的 `subagents` 配置定义专家团队：

| 子Agent | 职责 | 专用工具 | 模型建议 |
|---------|------|----------|---------|
| **query_planner** | 分析用户意图，生成多维度搜索查询，反思查询质量 | - | gpt-4o（需要强推理） |
| **summarizer** | 提取核心要点，生成结构化摘要 | - | gpt-4o-mini（简单任务） |
| **fact_checker** | 核查关键事实声明，标注可信度 | internet_search | gpt-4o（需要严谨） |
| **researcher** | 补充背景信息，关联历史事件 | internet_search | gpt-4o |
| **impact_assessor** | 评估短期/长期影响，预测发展 | - | gpt-4o（需要推理） |

**query_planner 的特殊性**：
- 这是工作流程中第一个被调用的子Agent
- 负责将用户的模糊需求转化为结构化的搜索策略
- 内置反思机制，评估查询的完备性和有效性
- 支持动态调整：如果检索结果不理想，MasterAgent 可再次咨询它

### 4.4 文件系统目录结构

利用 DeepAgents 的 FilesystemMiddleware 管理上下文：

```
/
├── raw/                    # 原始检索结果
│   ├── search_001.json     # 第一次搜索结果
│   └── search_002.json     # 第二次搜索结果
│
├── filtered/               # 筛选后的内容
│   └── articles.json       # 通过筛选的文章
│
├── analysis/               # 专家分析结果
│   ├── summarizer/         # 摘要专家输出
│   ├── fact_checker/       # 核查专家输出
│   ├── researcher/         # 研究专家输出
│   └── impact_assessor/    # 影响评估输出
│
├── integrated/             # 整合后的分析
│   └── merged.json         # 各专家结果合并
│
└── reports/                # 最终报告
    └── final.md            # Markdown 格式报告
```

---

## 五、四大范式实现策略

### 5.1 规划 (Planning)

**实现方式**：利用 DeepAgents 的 `write_todos` 工具

**触发时机**：
- 收到用户请求时，生成初始任务清单
- 反思后需要调整策略时，添加/修改 todo

**Todo 结构**：
```
[status] description
├─ [pending]     搜索"关键词1"
├─ [completed]   搜索"关键词2"  
├─ [in_progress] 筛选内容
├─ [pending]     深度分析
└─ [pending]     生成报告
```

**动态规划**：
- Agent 可随时读取 todo 状态（`read_todos`）
- 根据执行结果动态添加新 todo
- 跳过不必要的 todo

### 5.2 反思 (Reflection)

**实现方式**：在 system_prompt 中嵌入反思指令

**反思检查点**：

| 检查点 | 评估内容 | 可能的调整 |
|--------|---------|-----------|
| 检索后 | 结果数量、覆盖面、质量 | 扩展搜索词、更换信息源 |
| 筛选后 | 通过率、是否有遗漏 | 放宽/收紧标准、补充检索 |
| 分析后 | 各专家结论一致性 | 要求补充分析、协调冲突 |
| 生成前 | 报告完整性、信息准确性 | 补充缺失内容 |

**反思输出**：
- 记录反思结论到文件系统（如 `/reflection/note_001.md`）
- 根据反思结果修改 todo 列表

### 5.3 工具使用 (Tool Use)

**工具分类**：

| 类别 | 工具 | 来源 |
|------|------|------|
| 文件操作 | ls, read_file, write_file, edit_file, glob, grep | DeepAgents 内置 |
| 任务管理 | write_todos, read_todos | DeepAgents 内置 |
| 子Agent | task() | DeepAgents 内置 |
| 搜索检索 | internet_search | 自定义（Tavily） |
| 内容获取 | fetch_page | 自定义（httpx + bs4） |
| 质量评估 | evaluate_credibility, evaluate_relevance | 自定义 |

**工具调用策略**：
- 搜索工具：每个查询最多 5-10 条结果
- 抓取工具：限制正文长度（5000 字符）
- 评估工具：返回结构化分数 + 原因

### 5.4 多智能体协作 (MAC)

**实现方式**：DeepAgents 的 `task()` 工具 + subagents 配置

**协作模式**：

```
MasterAgent (协调者)
     │
     ├─── task("summarizer", article) ──► 摘要专家 ──► /analysis/sum/
     │
     ├─── task("fact_checker", article) ──► 核查专家 ──► /analysis/fact/
     │
     ├─── task("researcher", article) ──► 研究专家 ──► /analysis/bg/
     │
     └─── task("impact_assessor", article) ──► 评估专家 ──► /analysis/imp/
                                                              │
                                                              ▼
                                                    MasterAgent 整合结果
```

**上下文隔离**：
- 每个子 Agent 有独立的上下文窗口
- 主 Agent 只看到子 Agent 的最终输出
- 避免上下文污染和窗口溢出

**并行执行**：
- 多个子 Agent 可并行调用
- 提高分析效率

---

## 六、数据模型

### 6.1 核心实体

| 实体 | 描述 | 关键字段 |
|------|------|---------|
| **NewsItem** | 单条资讯 | id, title, url, source, summary, content, scores |
| **AnalysisResult** | 专家分析结果 | news_id, expert_role, analysis, confidence |
| **IntegratedSummary** | 整合后摘要 | article_id, title, integrated_analysis, references |

### 6.2 评分维度

| 维度 | 评估方式 | 分数范围 |
|------|---------|---------|
| **credibility_score** | 来源检查 + 标题党检测（规则） | 0.0 - 1.0 |
| **relevance_score** | LLM 评估（与领域相关性） | 0.0 - 1.0 |
| **heat_score** | 启发式规则（可选） | 0.0 - 1.0 |

---

## 七、模型配置策略

### 7.1 分角色配置

不同角色使用不同的模型配置，优化成本和效果：

| 角色 | 推荐模型 | Temperature | 说明 |
|------|---------|-------------|------|
| MasterAgent | gpt-4o | 0.1 | 主控需要稳定 |
| summarizer | gpt-4o-mini | 0.0 | 简单任务，低成本 |
| fact_checker | gpt-4o | 0.0 | 需要严谨 |
| researcher | gpt-4o | 0.2 | 需要一定发散 |
| impact_assessor | gpt-4o | 0.3 | 预测需要创造性 |
| 筛选评估 | gpt-4o-mini | 0.0 | 简单判断 |
| 报告生成 | gpt-4o | 0.4 | 需要更好文笔 |

### 7.2 成本优化

- **简单任务用小模型**：筛选、摘要等用 gpt-4o-mini
- **复杂任务用大模型**：规划、核查、报告等用 gpt-4o
- **缓存复用**：相同配置的模型实例复用

---

## 八、项目结构

```
news-report-agent/
├── pyproject.toml              # 依赖配置
├── README.md
├── TECHNICAL_DESIGN.md         # 本文档
├── IMPLEMENTATION_PLAN.md      # 实施计划
│
├── src/
│   ├── __init__.py
│   ├── config.py               # 应用配置（API keys, 模型配置等）
│   ├── models.py               # 模型角色枚举和配置
│   │
│   ├── agent/                  # Agent 核心
│   │   ├── __init__.py
│   │   ├── master.py           # MasterAgent 创建和配置
│   │   ├── subagents.py        # 专家子Agent 定义
│   │   └── prompts.py          # 系统提示词
│   │
│   ├── tools/                  # 自定义工具
│   │   ├── __init__.py
│   │   ├── search.py           # internet_search
│   │   ├── scraper.py          # fetch_page
│   │   └── evaluator.py        # evaluate_credibility, evaluate_relevance
│   │
│   └── utils/
│       ├── __init__.py
│       ├── logger.py           # 日志
│       └── templates.py        # 报告模板
│
├── cli/
│   ├── __init__.py
│   └── main.py                 # CLI 入口
│
├── tests/
│   ├── tools/                  # 工具单测
│   ├── agent/                  # Agent 单测
│   └── integration/            # 集成测试
│
└── data/                       # 运行时数据（可选持久化）
```

---

## 九、接口设计

### 9.1 CLI 接口

```bash
# 基础使用
python -m cli.main "今天科技圈有什么大事"

# 指定领域
python -m cli.main --domain finance "最新财经热点"

# 输出到文件
python -m cli.main --output ./reports/today.md "AI 领域进展"

# 启用详细日志
python -m cli.main --verbose "分析特斯拉最新动态"
```

### 9.2 程序化调用

```python
from src.agent import create_news_agent

agent = create_news_agent()
result = agent.invoke({
    "messages": [{"role": "user", "content": "分析今天的AI热点"}]
})
report = result["messages"][-1].content
```

---

## 十、质量保障

### 10.1 测试策略

| 测试类型 | 覆盖范围 | 方法 |
|----------|---------|------|
| 工具单测 | 每个自定义工具 | Mock 外部依赖，验证输入输出 |
| Agent 单测 | 子Agent 行为 | Mock LLM，验证提示词和工具调用 |
| 集成测试 | 端到端流程 | 使用测试数据，验证完整流程 |

### 10.2 可观测性

- **结构化日志**：记录每步操作、工具调用、耗时
- **Todo 追踪**：通过 read_todos 随时查看进度
- **文件系统审计**：所有中间结果可追溯

### 10.3 错误处理

| 场景 | 处理方式 |
|------|---------|
| 搜索 API 失败 | 重试 3 次，失败后记录并继续 |
| 网页抓取失败 | 跳过该 URL，记录原因 |
| LLM 输出解析失败 | 使用默认值兜底 |
| 子 Agent 超时 | 设置超时限制，超时返回空结果 |

---

## 十一、扩展性考虑

### 11.1 添加新工具

1. 在 `src/tools/` 下创建工具函数
2. 使用 `@tool` 装饰器或实现标准接口
3. 在 MasterAgent 创建时注册

### 11.2 添加新专家

1. 在 `src/agent/subagents.py` 中定义新专家配置
2. 指定 name, description, system_prompt, tools
3. 添加到 subagents 列表

### 11.3 自定义文件系统后端

DeepAgents 支持多种后端：
- **StateBackend**：内存（默认，会话内）
- **FilesystemBackend**：磁盘（长期持久化）
- **CompositeBackend**：混合（部分路径持久化）

---

## 十二、实施路线

详见 `IMPLEMENTATION_PLAN.md`，分 7 个 Phase 逐步实现：

1. **Phase 1**：Agent 基础骨架（MasterAgent + 内置工具验证）
2. **Phase 2**：自定义工具（搜索、抓取、评估）
3. **Phase 3**：规划与反思能力
4. **Phase 4**：专家子Agent
5. **Phase 5**：整合与报告
6. **Phase 6**：CLI 入口
7. **Phase 7**：测试与优化

---

本技术方案以 **DeepAgents** 为核心框架，充分利用其规划、文件系统、子Agent 能力，严格遵循 **Agentic AI 四大范式**（规划、反思、工具使用、多智能体协作），构建一个能够自主获取、筛选、分析热点资讯的智能代理系统。
